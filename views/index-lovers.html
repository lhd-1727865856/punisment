<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ä¾£ç‰ˆè‡ªè´£å•</title>
    <link rel="stylesheet" href="/css/style-lovers.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        .signature-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .signature-modal.active {
            display: flex;
        }

        .signature-container {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
        }

        .signature-canvas {
            border: 2px solid #FFB6C1;
            border-radius: 10px;
            margin-bottom: 15px;
            touch-action: none;
            background: #FFF0F5;
        }

        .signature-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .signature-button {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .signature-save {
            background: #FF69B4;
            color: white;
        }

        .signature-clear {
            background: #FFE4E1;
            color: #FF69B4;
            border: 1px solid #FFB6C1;
        }
    </style>
</head>
<body>
    <div class="container">
        <form class="self-criticism-form">
            <h1>æƒ…ä¾£ç‰ˆè‡ªè´£å•</h1>
            
            <div class="date-field">
                <input type="date" id="dateInput" class="date-input">
                <div class="date-display">
                    <span class="year"></span>å¹´
                    <span class="month"></span>æœˆ
                    <span class="day"></span>æ—¥
                </div>
            </div>

            <div class="form-group">
                <label>å§“åï¼š</label>
                <input type="text" name="name">
            </div>

            <div class="form-group">
                <label>äº‹ç”±ï¼š</label>
                <textarea name="reason" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label>è‡ªè´£ä¹¦ï¼š</label>
                <textarea name="apology" rows="5" placeholder="å†™ä¸‹ä½ çš„è‡ªè´£å†…å®¹..."></textarea>
            </div>

            <div class="form-group">
                <label>æƒ©ç½šï¼š</label>
                <textarea name="punishment" rows="3" placeholder="æ¯”å¦‚ï¼šè¯·ä½ åƒé¥­/çœ‹ç”µå½±/ä¹°å¥¶èŒ¶..."></textarea>
            </div>

            <div class="form-group">
                <label>ç­¾å­—ï¼š</label>
                <div class="signature-area"></div>
            </div>
        </form>
        
        <div class="share-button-container">
            <button type="button" id="shareButton" class="share-button">
                åˆ†äº« ğŸ“±
            </button>
        </div>
    </div>

    <div class="signature-modal">
        <div class="signature-container">
            <canvas class="signature-canvas"></canvas>
            <div class="signature-buttons">
                <button class="signature-button signature-clear">æ¸…é™¤</button>
                <button class="signature-button signature-save">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // æ—¥æœŸå¤„ç†
        const dateInput = document.getElementById('dateInput');
        const yearSpan = document.querySelector('.year');
        const monthSpan = document.querySelector('.month');
        const daySpan = document.querySelector('.day');

        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
        const today = new Date();
        dateInput.valueAsDate = today;
        updateDateDisplay(today);

        dateInput.addEventListener('change', (e) => {
            const selectedDate = new Date(e.target.value);
            updateDateDisplay(selectedDate);
        });

        function updateDateDisplay(date) {
            yearSpan.textContent = date.getFullYear();
            monthSpan.textContent = String(date.getMonth() + 1).padStart(2, '0');
            daySpan.textContent = String(date.getDate()).padStart(2, '0');
        }

        // æ·»åŠ åˆ†äº«åŠŸèƒ½
        document.getElementById('shareButton').addEventListener('click', async () => {
            try {
                // åˆ›å»ºåŠ è½½æç¤º
                const loadingTip = document.createElement('div');
                loadingTip.className = 'loading-tip';
                loadingTip.textContent = 'æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...';
                document.body.appendChild(loadingTip);

                // è·å–åˆ†äº«æŒ‰é’®å¹¶ä¸´æ—¶éšè—
                const shareButton = document.querySelector('.share-button-container');
                shareButton.style.display = 'none';

                // ä¿å­˜æ‰€æœ‰è¾“å…¥æ¡†çš„å€¼
                const inputs = document.querySelectorAll('input[type="text"], input[type="number"], textarea');
                const inputValues = Array.from(inputs).map(input => ({
                    element: input,
                    value: input.value,
                    type: input.type
                }));

                // å°†è¾“å…¥æ¡†è½¬æ¢ä¸ºspanæ˜¾ç¤º
                inputValues.forEach(({element, value}) => {
                    const span = document.createElement('span');
                    span.textContent = value;
                    span.style.cssText = `
                        display: block;
                        width: 100%;
                        padding: 12px;
                        border: 2px solid #FFB6C1;
                        border-radius: 10px;
                        font-size: 16px;
                        font-family: inherit;
                        background-color: #FFF0F5;
                        min-height: ${element.offsetHeight}px;
                        color: #FF69B4;
                        line-height: 1.5;
                        white-space: pre-wrap;
                        word-break: break-word;
                    `;
                    element.parentNode.insertBefore(span, element);
                    element.style.display = 'none';
                });

                // ç”Ÿæˆå›¾ç‰‡
                const container = document.querySelector('.container');
                const canvas = await html2canvas(container, {
                    backgroundColor: '#FFE5E5',
                    scale: 4,
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    imageTimeout: 0,
                    quality: 1.0
                });

                // æ¢å¤è¾“å…¥æ¡†æ˜¾ç¤º
                inputValues.forEach(({element}) => {
                    element.style.display = '';
                    element.previousSibling.remove();
                });

                // æ¢å¤æ˜¾ç¤ºåˆ†äº«æŒ‰é’®
                shareButton.style.display = '';

                // åˆ›å»ºå›¾ç‰‡é¢„è§ˆé®ç½©å±‚
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 999999;
                    padding: 20px;
                `;

                // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
                const img = document.createElement('img');
                img.src = canvas.toDataURL('image/png');
                img.style.cssText = `
                    max-width: 100%;
                    max-height: 80vh;
                    object-fit: contain;
                    border-radius: 10px;
                    margin-bottom: 20px;
                `;

                // åˆ›å»ºæç¤ºæ–‡æœ¬
                const tipText = document.createElement('div');
                tipText.style.cssText = `
                    color: white;
                    font-size: 16px;
                    text-align: center;
                    margin-bottom: 15px;
                `;
                tipText.textContent = 'é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ';

                // åˆ›å»ºå…³é—­æŒ‰é’®
                const closeButton = document.createElement('button');
                closeButton.style.cssText = `
                    background: #FF69B4;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 20px;
                    font-size: 16px;
                    cursor: pointer;
                    margin-top: 10px;
                `;
                closeButton.textContent = 'å…³é—­';

                // æ·»åŠ å…³é—­äº‹ä»¶
                const closeOverlay = () => {
                    overlay.remove();
                    loadingTip.remove();
                };

                closeButton.onclick = closeOverlay;
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        closeOverlay();
                    }
                };

                // ç»„è£…é¢„è§ˆç•Œé¢
                overlay.appendChild(img);
                overlay.appendChild(tipText);
                overlay.appendChild(closeButton);
                document.body.appendChild(overlay);

                // ç§»é™¤åŠ è½½æç¤º
                loadingTip.remove();

            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // ç­¾å­—åŠŸèƒ½
        const signatureArea = document.querySelector('.signature-area');
        const modal = document.querySelector('.signature-modal');
        const canvas = document.querySelector('.signature-canvas');
        const ctx = canvas.getContext('2d');
        const clearBtn = document.querySelector('.signature-clear');
        const saveBtn = document.querySelector('.signature-save');
        
        // è®¾ç½®ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            const container = document.querySelector('.signature-container');
            const width = container.clientWidth - 40; // å‡å»å†…è¾¹è·
            const height = Math.min(300, window.innerHeight * 0.4);
            
            canvas.width = width;
            canvas.height = height;
            
            // è®¾ç½®ç»˜å›¾ä¸Šä¸‹æ–‡çš„æ ·å¼
            ctx.strokeStyle = '#FF69B4';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        // åˆå§‹åŒ–ç­¾å­—ç›¸å…³äº‹ä»¶
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            
            [lastX, lastY] = [x, y];
        }

        // æ‰“å¼€ç­¾å­—æ¿
        signatureArea.addEventListener('click', () => {
            modal.classList.add('active');
            resizeCanvas();
        });

        // æ¸…é™¤ç­¾å­—
        clearBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        // ä¿å­˜ç­¾å­—
        saveBtn.addEventListener('click', () => {
            const signatureImage = canvas.toDataURL();
            signatureArea.style.backgroundImage = `url(${signatureImage})`;
            signatureArea.style.backgroundSize = 'contain';
            signatureArea.style.backgroundPosition = 'center';
            signatureArea.style.backgroundRepeat = 'no-repeat';
            signatureArea.classList.add('has-signature');
            modal.classList.remove('active');
        });

        // ç»˜ç”»äº‹ä»¶ç›‘å¬
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            [lastX, lastY] = [
                e.clientX - rect.left,
                e.clientY - rect.top
            ];
        });

        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', () => isDrawing = false);
        canvas.addEventListener('mouseout', () => isDrawing = false);

        // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            isDrawing = true;
            [lastX, lastY] = [
                touch.clientX - rect.left,
                touch.clientY - rect.top
            ];
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            draw(e);
        });

        canvas.addEventListener('touchend', () => isDrawing = false);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç½®ç”»å¸ƒå¤§å°
        window.addEventListener('resize', resizeCanvas);
    </script>
</body>
</html> 